name: NPM Publish

on:
  pull_request:
    types: [closed]
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true && github.event.pull_request.head.ref == 'changeset-release/main'
    outputs:
      was_published: ${{ steps.version_bumped.outputs.bumped }}
      version: ${{ steps.semver.outputs.version }}
      prerelease: ${{ steps.semver.outputs.prerelease }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Install PNPM
        uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: pnpm

      - name: Install Dependencies
        run: pnpm install

      - name: Create Release PR or Tag
        id: changesets
        uses: changesets/action@v1
        with:
          version: pnpm changeset version
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Detect version bump
        id: version_bumped
        run: |
          CURRENT_VERSION=$(jq -r .version packages/core/package.json)
          PREVIOUS_VERSION=$(git show HEAD^:packages/core/package.json | jq -r .version)

          echo "Current version:  $CURRENT_VERSION"
          echo "Previous version: $PREVIOUS_VERSION"

          if [ "$CURRENT_VERSION" != "$PREVIOUS_VERSION" ]; then
            echo "bumped=true" >> "$GITHUB_OUTPUT"
            echo "version=$CURRENT_VERSION" >> "$GITHUB_OUTPUT"
          else
            echo "bumped=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Extract version
        if: steps.version_bumped.outputs.bumped == 'true'
        uses: apexskier/github-semver-parse@v1
        id: semver
        with:
          version: ${{ steps.version_bumped.outputs.version }}

  publish_npm:
    name: Publish NPM Packages & Create GitHub Release
    if: github.event.pull_request.merged == true && github.event.pull_request.head.ref == 'changeset-release/main' && needs.release.outputs.was_published == 'true'
    runs-on: ubuntu-latest
    needs: [ release ]
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Install PNPM
        uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: pnpm

      - name: Install Dependencies
        run: pnpm install

      - name: Build Packages
        run: pnpm build

      - name: Add Credentials to .npmrc
        run: |
          echo "@monocloud:registry=https://registry.npmjs.org/" >> .npmrc
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" >> .npmrc
        shell: bash

      - name: Publish NPM packages
        run: |
          pnpm changeset publish --no-git-tag

      - name: Extract Core Changelog for Specific Version
        id: extract_changelog_core
        env:
          TARGET_VERSION: ${{ needs.release.outputs.version }}
          CHANGELOG_FILE: 'packages/core/CHANGELOG.md'
        run: |
          LOG_CONTENT=$(sed -n "/^## $TARGET_VERSION\$/,/^## /{/^## $TARGET_VERSION\$/d; /^## /d; p;}" $CHANGELOG_FILE)
          CLEAN_LOG_CONTENT=$(echo "$LOG_CONTENT" | sed 's/[ \t]*$//' | sed '/^$/d')
          echo "changelog_content<<EOF" >> $GITHUB_OUTPUT
          echo "$CLEAN_LOG_CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Extract Management Changelog for Specific Version
        id: extract_changelog_management
        env:
          TARGET_VERSION: ${{ needs.release.outputs.version }}
          CHANGELOG_FILE: 'packages/management/CHANGELOG.md'
        run: |
          LOG_CONTENT=$(sed -n "/^## $TARGET_VERSION\$/,/^## /{/^## $TARGET_VERSION\$/d; /^## /d; p;}" $CHANGELOG_FILE)
          CLEAN_LOG_CONTENT=$(echo "$LOG_CONTENT" | sed 's/[ \t]*$//' | sed '/^$/d')
          echo "changelog_content<<EOF" >> $GITHUB_OUTPUT
          echo "$CLEAN_LOG_CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Extract Identity Changelog for Specific Version
        id: extract_changelog_identity
        env:
          TARGET_VERSION: ${{ needs.release.outputs.version }}
          CHANGELOG_FILE: 'packages/identity/CHANGELOG.md'
        run: |
          LOG_CONTENT=$(sed -n "/^## $TARGET_VERSION\$/,/^## /{/^## $TARGET_VERSION\$/d; /^## /d; p;}" $CHANGELOG_FILE)
          CLEAN_LOG_CONTENT=$(echo "$LOG_CONTENT" | sed 's/[ \t]*$//' | sed '/^$/d')
          echo "changelog_content<<EOF" >> $GITHUB_OUTPUT
          echo "$CLEAN_LOG_CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Build Release Body
        id: build_body
        env:
          CORE_CHANGELOG: ${{ steps.extract_changelog_core.outputs.changelog_content }}
          MANAGEMENT_CHANGELOG: ${{ steps.extract_changelog_management.outputs.changelog_content }}
          IDENTITY_CHANGELOG: ${{ steps.extract_changelog_identity.outputs.changelog_content }}
        run: |
          body=""

          if [ -n "$CORE_CHANGELOG" ]; then
            body="${body}### ðŸ“¦ Core"$'\n'"$CORE_CHANGELOG"$'\n\n\n'
          fi

          if [ -n "$MANAGEMENT_CHANGELOG" ]; then
            body="${body}### ðŸ’» Management"$'\n'"$MANAGEMENT_CHANGELOG"$'\n\n\n'
          fi

          if [ -n "$IDENTITY_CHANGELOG" ]; then
            body="${body}### ðŸ‘¤ Identity"$'\n'"$IDENTITY_CHANGELOG"$'\n\n'
          fi

          {
            echo 'body<<EOF'
            printf '%s\n' "$body"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        if: github.event.pull_request.merged == true && github.event.pull_request.head.ref == 'changeset-release/main' && needs.release.outputs.was_published == 'true'
        uses: ncipollo/release-action@v1
        with:
          tag: v${{ needs.release.outputs.version }}
          prerelease: ${{ !!needs.release.outputs.prerelease }}
          name: v${{ needs.release.outputs.version }}
          body: ${{ steps.build_body.outputs.body }}
